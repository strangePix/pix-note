# 授权认证



## JWT

JWT是JSON WEB TOKEN的缩写，它是基于 RFC 7519 标准定义的一种可以安全传输的的JSON对象，由于使用了数字签名，所以是可信任和安全的。



### 组成

- JWT token的格式：header.payload.signature

- header中用于存放签名的生成算法

  ```json
  {"alg": "HS512"}
  ```

- payload中用于存放用户名、token的生成时间和过期时间

  ```json
  {"sub":"admin","created":1489079981393,"exp":1489684781}
  ```

- signature为以header和payload生成的签名，一旦header和payload被篡改，验证将失败

  ```java
  //secret为加密算法的密钥
  String signature = HMACSHA512(base64UrlEncode(header) + "." +base64UrlEncode(payload),secret)
  ```



### 实例

在该网站上获得解析结果：https://jwt.io/

如：

```sh
eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhZG1pbiIsImNyZWF0ZWQiOjE1NTY3NzkxMjUzMDksImV4cCI6MTU1NzM4MzkyNX0.d-iki0193X0bBOETf2UN3r3PotNIEAV7mzIxxeI5IxFyzzkOZxS0PGfF_SK6wxCv2K8S0cZjMkv6b5bCqc0VBw
```

![img](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/arch_screen_13.fc3ff0ff.png)



### 实现认证和授权的原理

- 用户调用登录接口，登录成功后获取到JWT的token；
- 之后用户每次调用接口都在http的header中添加一个叫Authorization的头，值为JWT的token；
- 后台程序通过对Authorization头中信息的解码及数字签名校验来获取其中的用户信息，从而实现认证和授权。







## CAS



### 快速搭建本地CAS服务端

#### 基本步骤

这里选用的CAS版本为5.3.1 更高版本依赖与jdk超过8，暂时不适合个人使用

- 拉取官方CAS代码，切换5.3分支

  ```shell
  https://github.com/apereo/cas-overlay-template.git
  ```

- 进入目录，直接打包，会生成一个cas.war包在target目录下

  ```shell
  cd cas-overlay-template 
  build package
  ```

- 打包后部署tomcat

  - 直接部署的话就是将target目录下的cas目录拷贝到tomcat的webapps目录下，启动tomcat

  - 使用idea的话，如图配置，在不修改现有项目的代码的情况下

    <img src="https://img-blog.csdnimg.cn/e749137c4a0c437bb87c2caa7aea828c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQ29kZXJfS25pZ2h0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img" style="zoom: 80%;" />

    

    ![img](https://img-blog.csdnimg.cn/aa59d954ec594c11a263b1810bef7357.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQ29kZXJfS25pZ2h0,size_20,color_FFFFFF,t_70,g_se,x_16)

- 启动后访问http://localhost:8080/cas 端口可自行更改

  ![image-20220823134753457](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/202208231347506.png)

#### 默认账号密码

修改target/cas目录下WEB-INF下的application.properties配置项，重新打包

```properties
# application.properties中存在配置项，默认即为  账号casuser 密码Mellon
cas.authn.accept.users=casuser::Mellon
```

#### 延长ST有效期

某些情况下认证ticket生成后的校验时间异常长（目前未知原因），而ST默认有效期10s，此时生成后再验证过期导致校验失败，经过查找application.properties配置项为

```properties
# 单位为s
cas.ticket.st.timeToKillInSeconds=10
```

#### 为本地CAS服务配置域名和https证书

校验需要对服务端https证书校验，本地模拟时需要进行同步配置。

##### 编辑本地hosts 

添加自定义域名映射，比如这里设置本地域名为test.sso.com

hosts文件位置：C:\Windows\System32\drivers\etc\hosts

```text
127.0.0.1 test.sso.com
```

##### 为tomcat申请https本地证书

这里参考tomcat笔记，利用jdk自带keytool工具，内容暂时不作解释 tomcat版本为9

- 生成证书，在指令当前目录生成一个文件.keystore，这里生成到tomcat目录/conf下

  ```shell
  keytool -genkeypair -alias ssoKey  -keyalg RSA -keysize 2048 -keypass 123456 -storepass 123456 -keyalg RSA  -validity 3650  -keystore ./.keystore   -dname "CN=test.sso.com,OU=pix,O=pix,L=ZZ,ST=HN,C=CN" -deststoretype pkcs12
  ```

- jdk安装证书，因为校验需要，这个证书要存放在运行cas客户端的jdk中

  ```shell
  keytool -export -file ./.keystore.crt -alias ssoKey -keystore ./.keystore -storepass 123456
  # 需要输入jdk密钥库密码 默认changeit  选择信任  这里alias可以与之前不一样 存进去会变成全小写
  keytool -import -alias sso -file ./.keystore.crt -keystore $env:JAVA_HOME\jre\lib\security\cacerts -storepass changeit
  ```

- 检查是否已安装

  ```shell
  keytool -list -keystore $env:JAVA_HOME\jre\lib\security\cacerts -storepass changeit|findstr sso 
  # 删除证书
  keytool -delete -alias sso -keystore $env:JAVA_HOME\jre\lib\security\cacerts -storepass changeit
  ```

  ![image-20220824235402898](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/202208242354969.png)

- 配置证书到tomcat，进入tomcat目录下conf/server.xml  解开如下注释

  ```xml
  <Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"
             maxThreads="150" SSLEnabled="true">
      <SSLHostConfig>
          <Certificate certificateKeystoreFile="conf/localhost-rsa.jks"
                       type="RSA" />
      </SSLHostConfig>
  </Connector>
  ```

  修改如下：

  ```xml
  <Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"
             maxThreads="150" SSLEnabled="true">
      <SSLHostConfig>
          <Certificate certificateKeystoreFile="conf/.keystore"
                       certificateKeystorePassword="123456"
                       type="RSA" />
      </SSLHostConfig>
  </Connector>
  ```

- 此时启动的tomcat即可支持test.sso.com 的https请求，对应端口号8443

#### 默认不支持http认证：未认证授权的服务

![img](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/202208231358412.png)

本地测试客户端可能没有https证书又没必要配，可以配置支持http请求

同样是application.properties

```shell
#设置安全为false
cas.tgc.secure=false
#开启识别json文件，默认false
cas.serviceRegistry.initFromJson=true
 
# 配置允许登出后跳转到指定页面
cas.logout.followServiceRedirects=true
# 跳转到指定页面需要的参数名为 service
cas.logout.redirectParameter=service
```

然后修改WEB-INF\classes\services\HTTPSandIMAPS-10000001.json，为serviceId中的正则表达式添加http的或条件

```json
{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|http|imaps)://.*",
  "name" : "HTTPS and IMAPS",
  "id" : 10000001,
  "description" : "This service definition authorizes all application urls that support HTTPS and IMAPS protocols.",
  "evaluationOrder" : 10000
}
```

#### 使用数据库查询用户

- 搭建用户数据库

  ```mysql
  -- 创建数据库表空间
  CREATE DATABASE test_cas DEFAULT CHARSET utf8 COLLATE utf8_general_ci;  
  USE test_cas;  
  -- 创建帐号信息表
  DROP TABLE IF EXISTS `cas_user_base`;  
  CREATE TABLE `cas_user_base` (  
    `id` INT(11) NOT NULL AUTO_INCREMENT,  
    `user_name` VARCHAR(45) DEFAULT NULL,  
    `user_psd` VARCHAR(45) DEFAULT NULL,  
    PRIMARY KEY (`id`)  
  );  
  -- 插入登录帐号数据
  INSERT INTO `cas_user_base` VALUES (1,'123','123'),(2,'admin','123456');
  ```

- **cas overlay添加数据库的JDBC插件，在pom.xml增加如下配置**

  ```xml
  <!-- Database Authentication Begin -->
  <dependency>
      <groupId>org.apereo.cas</groupId>
      <artifactId>cas-server-support-jdbc</artifactId>
      <version>${cas.version}</version>
  </dependency>
  <dependency>
     <groupId>org.apereo.cas</groupId>
     <artifactId>cas-server-support-jdbc-drivers</artifactId>
     <version>${cas.version}</version>
  </dependency>
  <!-- Database Authentication End -->
  ```

  这里因为用的是mysql，所以可以不导入cas-server-support-jdbc-drivers，而是直接导入mysql驱动

  ```xml
  <dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
      <version>5.1.47</version>
  </dependency>
  ```

- **增加数据库连接配置**

  创建目录\casoverlay\cas-overlay-template\src\main\resources，新增文件application.properties，增加数据库配置

  ```properties
  cas.authn.jdbc.query[0].sql=SELECT * FROM cas_user_base WHERE user_name=?
  cas.authn.jdbc.query[0].url=jdbc:mysql://localhost:3306/test_cas?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&useSSL=false&serverTimezone=UTC
  cas.authn.jdbc.query[0].dialect=org.hibernate.dialect.MySQLDialect
  cas.authn.jdbc.query[0].user=root
  cas.authn.jdbc.query[0].password=
  cas.authn.jdbc.query[0].driverClass=com.mysql.jdbc.Driver
  cas.authn.jdbc.query[0].fieldPassword=user_psd
  ```

- 再重新打包部署即可
