# 消息队列



## RabbitMQ

RabbitMQ是一个被广泛使用的开源消息队列。它是轻量级且易于部署的，它能支持多种消息协议。RabbitMQ可以部署在分布式和联合配置中，以满足高规模、高可用性的需求。



### 安装

#### Win

- 安装环境Erlang，下载地址 http://erlang.org/download/otp_win64_21.3.exe

- 安装RabbitMQ，下载地址 https://dl.bintray.com/rabbitmq/all/rabbitmq-server/3.7.14/rabbitmq-server-3.7.14.exe

- 找到安装后的启动图标

  ![image-20220508185939599](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/image-20220508185939599.png)

  或者进入RabbitMQ安装目录下的sbin目录

  ![img](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/arch_screen_55.cff0e57a.png)

  通过指令启动

  ```shell
  rabbitmq-plugins enable rabbitmq_management
  ```

- 访问地址：http://localhost:15672/

  ![img](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/arch_screen_57.f0fc20b9.png)

### 配置操作

访问http://localhost:15672/ 进入rabbitMQ图形化界面

默认账号guest guest 进行登录

#### 创建用户

![img](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/arch_screen_58.2d67e0fe.png)

> 通过tags设置角色

#### 创建虚拟host

![img](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/arch_screen_59.6d1d4f9f.png)

#### 为用户分配host

![img](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/arch_screen_61.f2470471.png)





### 与SpringBoot整合

#### 引入依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

#### 配置文件

```yaml
spring:
    rabbitmq:
            host: localhost # rabbitmq的连接地址
            port: 5672 # rabbitmq的连接端口号
            virtual-host: /xxx # rabbitmq的虚拟host
            username: guest # rabbitmq的用户名
            password: guest # rabbitmq的密码 #如果对异步消息需要回调必须设置为true
            publisher-confirm-type: correlated  # 如果对异步消息需要回调必须设置
```

默认账号 guest guest



## RocketMQ

### 安装

#### Win

- 访问 https://archive.apache.org/dist/rocketmq/ 选择合适版本的安装包下载，这里选择https://archive.apache.org/dist/rocketmq/4.9.3/rocketmq-all-4.9.3-bin-release.zip

- 解压安装包，将文件夹中的rocketmq-4.9.3文件夹放置在自行选择的安装位置，这里个人选择 D:\soft\rocketmq\rocketmq-4.9.3

- 配置环境变量

  ```properties
  # rocket安装目录
  ROCKETMQ_HOME="D:\soft\rocketmq\rocketmq-4.9.3"
  ```

- 启动**Namesrv**，进入bin目录，运行mqnamesrv.cmd文件，请勿关闭

  ```shell
  ./mqnamesrv.cmd
  # 或者 区别在于后者异步 可以并行执行
  start mqnamesrv.cmd
  ```

  > 系统提示Please set the JAVA_HOME variable in your environment, We need java(x64)!
  >
  > 则配置环境变量
  >
  > ```properties
  > # 注意是根目录 而非bin目录位置
  > JAVA_HOME="JDK根目录位置"
  > ```

![image-20220815112054426](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/202208151120590.png)

- 启动**Broker** ，请勿关闭

  ```shell
  mqbroker.cmd -n 127.0.0.1:9876 autoCreateTopicEnable=true
  # 或者 
  start mqbroker.cmd -n 127.0.0.1:9876 autoCreateTopicEnable=true
  ```

  > autoCreateTopicEnable表示Topic自动创建，生产环境不建议配置（待补充）

#### 可视化/Web控制台

rocketmq-dashboard是使用springboot设计的RocketMq的后台系统,有了它,我们可以很方便的在Web页面上管理RocketMq的消息，topic等。

- 拉取rocketmq-dashboard代码

  ```shell
  git clone https://github.com/apache/rocketmq-dashboard.git
  ```

- 配置文件在src/main/resources/application.yml，可以进行修改

  ```properties
  # RocketMQ Namesrv 的地址
  rocketmq.config.namesrvAddr=127.0.0.1:9876
  # 端口号
  server.port=8080
  ```

- 编译源码，要求有maven，jar包启动

  ```shell
  mvn clean package -Dmaven.test.skip=true
  java -jar target/rocketmq-dashboard-1.0.1-SNAPSHOT.jar
  # 或者用maven的Springboot启动
  mvn spring-boot:run
  ```

  > 因为是一个SpringBoot项目，实际也可以用IDEA打开手动启动

- 访问本地http://127.0.0.1:8080/ 即可。

  <img src="https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/202208151135609.jpeg" alt="RocketMQ Console" style="zoom:50%;" />

- 使用一次后可以固定jar包位置固定启动。

#### 配置服务

Win里想要实现开机自启，以及灵活控制后台启动与关闭，可以通过配置服务的方式实现，但服务只支持exe文件类型。

这里使用nssm将rocket启动注册为服务（参考https://www.cnblogs.com/rossoneri22/p/15830213.html）：

- 首先编写启动脚本，命名为rocketmq-start.bat（自定义）

  ```bash
  # 相对位置根据你的脚本与mqnamesrv指令的相对位置而定，也可以写绝对位置
  start .\bin\mqnamesrv.cmd
  start .\bin\mqbroker.cmd -n localhost:9876 autoCreateTopicEnable=true
  ```

- 下载nssm，下载地址：https://nssm.cc/download，并解压缩

- 选择操作系统对应的版本，如64位，则进入win64目录，运行指令

  ```shell
  # 服务名RocketMQ自定义
  .\nssm install RocketMQ
  ```

  弹出配置框，选择运行的指令文件，以及执行命令的目录，点击Install service

  ![image-20220815135020097](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/202208151350008.png)

- 然后查看服务列表，安装成功

  ![image-20220815135121486](https://strangest.oss-cn-shanghai.aliyuncs.com/markdown/202208151351510.png)

- 如果需要把控制台项目也一并启动可以将jar命令写到启动脚本即可。
